---
name: chaos testing for kubi with Litmus
on:
  - push
jobs:
  kind:
    runs-on: ubuntu-latest
    name: create cluster KinD  with (1.21,1.23) Kub version
    strategy:
      fail-fast: false
      matrix:
        kubernetes:
          - 1.21
    steps:
      - name: checkout
        uses: actions/checkout@v3
      - name: Create cluster KinD
        uses: helm/kind-action@v1.4.0
        with:
          config: .github/kind-cluster-${{ matrix.kubernetes }}.yaml
      - name: testing cluster kinD
        run: kubectl cluster-info --context kind-chart-testing echo " current-context:"
          $(kubectl config current-context)
                 
      - name: Setting up kubeconfig ENV for Github Chaos Action
        run: echo ::set-env name=KUBE_CONFIG_DATA::$(base64 -w 0 ~/.kube/config)
        env:
          ACTIONS_ALLOW_UNSECURE_COMMANDS: true
      
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Set up Go
        uses: actions/setup-go@v2
        with:
          go-version: 1.17
          go-path: ${{ github.workspace }}/go
          
      - name: Set GOROOT
        run: echo "export GOROOT=/opt/hostedtoolcache/go/1.17.13/x64" >> $GITHUB_ENV

      - name: Install cfssl and cfssljson
        run: |
            VERSION=$(curl --silent "https://api.github.com/repos/cloudflare/cfssl/releases/latest" | grep '"tag_name"' | sed -E 's/.*"([^"]+)".*/\1/')
            VNUMBER=${VERSION#"v"}
            wget https://github.com/cloudflare/cfssl/releases/download/${VERSION}/cfssljson_${VNUMBER}_linux_amd64 -O cfssljson
            chmod +x cfssljson
            sudo mv cfssljson /usr/local/bin
            
            cfssljson -version
            VERSION=$(curl --silent "https://api.github.com/repos/cloudflare/cfssl/releases/latest" | grep '"tag_name"' | sed -E 's/.*"([^"]+)".*/\1/')
            VNUMBER=${VERSION#"v"}
            wget https://github.com/cloudflare/cfssl/releases/download/${VERSION}/cfssl_${VNUMBER}_linux_amd64 -O cfssl
            chmod +x cfssl
            sudo mv cfssl /usr/local/bin
 
      
          
      - name: Create certificate for kubi
        run : |
         chmod +x ./.github/Csr.sh
         ./.github/Csr.sh
        
      - name: crete secret for kubi ldap
        run: |
          kubectl -n kube-system create secret generic kubi-secret \
           --from-literal ldap_passwd='password'
           
      - name: deploy crds 
        run : |
            kubectl apply -f https://raw.githubusercontent.com/ca-gip/kubi/master/deployments/kube-crds.yml

      - name: Deploy the prerequisites
        run: |
         kubectl apply -f https://raw.githubusercontent.com/ca-gip/kubi/master/deployments/kube-prerequisites.yml
       
      - name:  local config (ldap deploy + configmap kubi-ldap + configmap openldap)
        run: |
          kubectl apply -f https://raw.githubusercontent.com/ca-gip/kubi/master/deployments/kube-local-config.yml
          
       # Copy the secret from you Kubernetes cluster
     
      - name: Create secret dirs on your local machine   
        run : |
               sudo mkdir -p  /var/run/secrets/{certs,ecdsa,kubernetes.io}
               sudo mkdir  /var/run/secrets/kubernetes.io/serviceaccount
              
               kubectl -n kube-system get secrets $( kubectl -n kube-system get sa kubi-user -o "jsonpath={.secrets[0].name}") -o "jsonpath={.data['ca\.crt']}" | base64 -d > ca.crt
               kubectl -n kube-system get secrets $(kubectl -n kube-system get sa kubi-user -o "jsonpath={.secrets[0].name}") -o "jsonpath={.data['token']}" | base64 -d > token
               kubectl -n kube-system get secrets kubi -o "jsonpath={.data['tls\.crt']}" | base64 -d > tls.crt
               kubectl -n kube-system get secrets kubi -o "jsonpath={.data['tls\.key']}" | base64 -d > tls.key
               kubectl -n kube-system get secrets kubi-encryption-secret -o "jsonpath={.data['ecdsa-key\.pem']}" | base64 -d > ecdsa-key.pem
               kubectl -n kube-system get secrets kubi-encryption-secret -o "jsonpath={.data['ecdsa-public\.pem']}" | base64 -d > ecdsa-public.pem
               sudo mv ca.crt /var/run/secrets/kubernetes.io/serviceaccount/
               sudo mv token /var/run/secrets/kubernetes.io/serviceaccount/
               sudo mv tls.crt /var/run/secrets/certs/
               sudo mv tls.key /var/run/secrets/certs/
               sudo mv ecdsa-public.pem /var/run/secrets/ecdsa/
               sudo mv ecdsa-key.pem /var/run/secrets/ecdsa/
               sudo ls /var/run/secrets/kubernetes.io/serviceaccount/
               sudo ls /var/run/secrets/ecdsa/
               sudo ls /var/run/secrets/certs/
               

      - name : shecking for deploys
        run : |
              kubectl get all -n kube-system
              kubectl get configmap -n kube-system
              kubectl get secret -n kube-system
        
      - name: deploy kubi Api
        run: |
         
               API_URL=$(kubectl config view --minify --output 'jsonpath={.clusters[].cluster.server}')
               API_PORT=${API_URL##*:}
               echo "API port: $API_PORT"
               echo "API URL: $API_URL"
               git clone https://github.com/ca-gip/kubi.git
               cd  kubi/cmd/api/
               pwd 
               ls

               LDAP_ADMIN_GROUPBASE="cn=DL_ADMIN_TEAM,OU=GLOBAL,ou=Groups,dc=kubi,dc=ca-gip,dc=github,dc=com" \
               LDAP_ADMIN_USERBASE="dc=kubi,dc=ca-gip,dc=github,dc=com"  \
               LDAP_BINDDN="cn=admin,dc=kubi,dc=ca-gip,dc=github,dc=com"   \
               LDAP_GROUPBASE="ou=LOCAL,ou=Groups,dc=kubi,dc=ca-gip,dc=github,dc=com"  \
               LDAP_PORT="389"   \
               LDAP_SERVER="kube-ldap.kube-system.svc.cluster.local"  \
               LDAP_USE_SSL="false"   \
               LDAP_USERBASE="ou=People,dc=kubi,dc=ca-gip,dc=github,dc=com"   \
               LDAP_USERFILTER="(cn=%s)"   \
               LOCATOR="local"   \
               PUBLIC_APISERVER_URL="https://kubernetes.default.svc.cluster.local"  \
               TENANT="cagip" \
               KUBERNETES_SERVICE_HOST="kubernetes.default.svc.cluster.local" \
               KUBERNETES_SERVICE_PORT="API_PORT" \
               LDAP_PASSWD="password" \
               go run main.go &
           
      - name: Installer ldap-utils and add
        run: |
              # Attendre que le pod OpenLDAP soit prÃªt
              kubectl wait --for=condition=Ready pod -n kube-system -l app=kubi-ldap
              kubectl exec -n kube-system $(kubectl get pods -n kube-system -l app=kubi-ldap -o jsonpath='{.items[0].metadata.name}') -- su -c  "apt-get update && apt-get install -y ldap-utils &&
              ldapadd -x -D  cn=admin,dc=kubi,dc=ca-gip,dc=github,dc=com -w password <<EOF
              dn: cn=DL_KUB_YANIS-TEST-DEV_ADMIN,ou=LOCAL,ou=Groups,dc=kubi,dc=ca-gip,dc=github
               ,dc=com
              objectClass: top
              objectClass: groupOfNames
              cn: DL_KUB_CHAOS-DEV_ADMIN
              member: cn=mario,ou=People,dc=kubi,dc=ca-gip,dc=github,dc=com
              member: cn=luigi,ou=People,dc=kubi,dc=ca-gip,dc=github,dc=com
              EOF"
      - name: existing  namespaces test 
        run:  |
               pwd
               ls
               go get k8s.io/client-go/tools/clientcmd@v0.20.4
               go build -o app ./.github/test.go
               sleep 15m
               kubectl get ns
        
               
              
              
              
              
              
              
